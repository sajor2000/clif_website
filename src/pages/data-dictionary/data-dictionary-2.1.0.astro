---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Badge from '../../components/Badge.astro';
import DataTable from '../../components/DataTable.astro';

// Define v2.1.0 specific updates
const v21Updates = {
  adt: {
    newFields: [
      {
        name: 'location_type',
        type: 'VARCHAR',
        description: 'Maps ICU type to a standardized list of ICU categories',
        values: [
          'Medical ICU',
          'Surgical ICU',
          'Cardiac ICU',
          'Neuro ICU',
          'Burn ICU',
          'Trauma ICU',
          'Mixed ICU',
          'Other',
        ],
      },
    ],
  },
  hospitalization: {
    updates: ['Finalized admission_type_category mCIDE', 'Added LTACH to admission_type mCIDE'],
  },
  patient: {
    updates: ['Finalized language_category mCIDE'],
  },
};

// Beta tables (including new ones promoted from Concept)
const betaTables = [
  {
    id: 'crrt-therapy',
    name: 'CRRT Therapy',
    description:
      'The crrt_therapy table captures Continuous Renal Replacement Therapy (CRRT) data, including different CRRT modalities, operational parameters, and fluid exchange details.',
    fields: [
      {
        name: 'hospitalization_id',
        type: 'VARCHAR',
        description: 'Unique identifier for hospitalization episode',
      },
      {
        name: 'recorded_dttm',
        type: 'DATETIME',
        description: 'Timestamp when CRRT parameters were recorded (UTC)',
      },
      { name: 'crrt_mode_name', type: 'VARCHAR', description: 'Name of CRRT mode from source' },
      {
        name: 'crrt_mode_category',
        type: 'VARCHAR',
        description: 'Standardized CRRT modes',
        values: ['scuf', 'cvvh', 'cvvhd', 'cvvhdf'],
      },
      {
        name: 'dialysis_machine_name',
        type: 'VARCHAR',
        description: 'Unique identifier for the dialysis machine',
      },
      {
        name: 'blood_flow_rate',
        type: 'DOUBLE',
        description: 'Rate of blood flow through the CRRT circuit (mL/hr)',
      },
      {
        name: 'pre_filter_replacement_fluid_rate',
        type: 'DOUBLE',
        description: 'Rate of pre-filter replacement fluid infusion (mL/hr)',
      },
      {
        name: 'post_filter_replacement_fluid_rate',
        type: 'DOUBLE',
        description: 'Rate of post-filter replacement fluid infusion (mL/hr)',
      },
      {
        name: 'dialysate_flow_rate',
        type: 'DOUBLE',
        description: 'Flow rate of dialysate solution (mL/hr)',
      },
      {
        name: 'ultrafiltration_out',
        type: 'DOUBLE',
        description: 'Net ultrafiltration output (mL)',
      },
    ],
  },
  {
    id: 'ecmo-mcs',
    name: 'ECMO_MCS',
    description:
      'The ECMO/MCS table is a wider longitudinal table that captures the start and stop times of ECMO/MCS support, the type of device used, and the work rate of the device.',
    fields: [
      {
        name: 'hospitalization_id',
        type: 'VARCHAR',
        description: 'Unique identifier for the hospitalization event',
      },
      {
        name: 'recorded_dttm',
        type: 'DATETIME',
        description: 'Date and time when device settings were recorded (UTC)',
      },
      {
        name: 'device_name',
        type: 'VARCHAR',
        description: 'Name of the ECMO/MCS device including brand',
      },
      {
        name: 'device_category',
        type: 'VARCHAR',
        description: 'Standardized device categories',
        values: ['Impella', 'Centrimag', 'TandemHeart', 'HeartMate', 'ECMO', 'Other'],
      },
      {
        name: 'mcs_group',
        type: 'VARCHAR',
        description: 'MCS type groupings',
        values: ['durable_LVAD', 'temporary_LVAD', 'RVAD', 'IABP', 'ECMO'],
      },
      {
        name: 'device_metric_name',
        type: 'VARCHAR',
        description: 'Measure of work rate (e.g., RPMs)',
      },
      { name: 'device_rate', type: 'DOUBLE', description: 'Numeric value of work rate' },
      { name: 'flow', type: 'DOUBLE', description: 'Blood flow in L/min' },
      { name: 'sweep', type: 'DOUBLE', description: 'Gas flow rate in L/min' },
      { name: 'fdO2', type: 'DOUBLE', description: 'Fraction of delivered oxygen' },
    ],
  },
  {
    id: 'microbiology-noncultures',
    name: 'Microbiology Non-cultures',
    description:
      'Captures microbiology test results that are not based on culture methods, including PCR, antigen tests, and other rapid diagnostic methods.',
    fields: [
      {
        name: 'hospitalization_id',
        type: 'VARCHAR',
        description: 'Unique identifier for hospitalization',
      },
      { name: 'test_order_dttm', type: 'DATETIME', description: 'When test was ordered (UTC)' },
      {
        name: 'test_collect_dttm',
        type: 'DATETIME',
        description: 'When specimen was collected (UTC)',
      },
      {
        name: 'test_result_dttm',
        type: 'DATETIME',
        description: 'When results were available (UTC)',
      },
      { name: 'test_name', type: 'VARCHAR', description: 'Original test name from source' },
      { name: 'test_category', type: 'VARCHAR', description: 'Standardized test categories' },
      { name: 'specimen_source_name', type: 'VARCHAR', description: 'Original specimen source' },
      {
        name: 'specimen_source_category',
        type: 'VARCHAR',
        description: 'Standardized specimen sources',
      },
      { name: 'organism_name', type: 'VARCHAR', description: 'Detected organism/pathogen' },
      {
        name: 'organism_category',
        type: 'VARCHAR',
        description: 'Standardized organism categories',
      },
      { name: 'result_value', type: 'VARCHAR', description: 'Test result (positive/negative/etc)' },
    ],
  },
];
---

<BaseLayout
  title="CLIF-2.1.0 Data Dictionary (Future Release)"
  description="Upcoming version of the Common Longitudinal ICU data Format"
>
  <div class="container mx-auto px-6 py-12">
    <div class="bg-clif-burgundy-light/10 border-2 border-clif-burgundy/20 p-4 rounded-lg mb-8">
      <p class="text-lg font-semibold text-blue-800">
        📅 This version is scheduled for release in September 2025. For current implementation, use <a
          href="/data-dictionary"
          class="text-clif-burgundy hover:underline">CLIF v2.0.0</a
        >.
      </p>
    </div>

    <h1 class="text-4xl font-bold text-clif-burgundy mb-2">
      CLIF-2.1.0 Data Dictionary
      <span class="ml-3 bg-clif-burgundy text-white text-sm px-3 py-1 rounded-full align-middle"
        >Work in Progress</span
      >
    </h1>

    <div class="prose prose-lg max-w-none">
      <p class="text-xl mb-8">
        The CLIF Data Dictionary serves as a comprehensive guide to the Common Longitudinal ICU data
        Format, detailing the structure and purpose of each table within the framework. Version
        2.1.0 introduces several important updates including promotion of tables to Beta status and
        finalized mCIDE categories.
      </p>

      <div class="my-8">
        <img
          src="/images/data-dictionary/ERD-2.1.0.png"
          alt="Entity Relationship Diagram v2.1.0"
          class="w-full max-w-4xl mx-auto border shadow-lg"
        />
      </div>

      <!-- Key Changes Section -->
      <section class="mb-12 bg-green-50 p-6 rounded-lg">
        <h2 class="text-2xl font-bold text-clif-burgundy mb-4">Key Changes in v2.1.0</h2>

        <h3 class="text-xl font-semibold mt-4 mb-2">Tables Promoted to Beta Status</h3>
        <ul class="list-disc list-inside space-y-2 ml-4">
          <li><strong>CRRT Therapy</strong> - Continuous Renal Replacement Therapy data capture</li>
          <li>
            <strong>ECMO_MCS</strong> - Extracorporeal Membrane Oxygenation and Mechanical Circulatory
            Support
          </li>
          <li>
            <strong>Microbiology Non-cultures</strong> - PCR, antigen tests, and rapid diagnostics
          </li>
        </ul>

        <h3 class="text-xl font-semibold mt-4 mb-2">Updated mCIDE Categories</h3>
        <ul class="list-disc list-inside space-y-2 ml-4">
          <li>
            <strong>ADT Table</strong>: Added <code class="bg-gray-200 px-2 py-1 rounded"
              >location_type</code
            > field with standardized ICU categories
          </li>
          <li>
            <strong>Patient Table</strong>: Finalized <code class="bg-gray-200 px-2 py-1 rounded"
              >language_category</code
            > mCIDE
          </li>
          <li>
            <strong>Hospitalization Table</strong>: Finalized <code
              class="bg-gray-200 px-2 py-1 rounded">admission_type_category</code
            > mCIDE, added LTACH
          </li>
        </ul>
      </section>

      <h2 class="text-2xl font-bold text-clif-burgundy mt-12 mb-4">Beta Tables</h2>
      <p class="mb-6">
        The table purpose, structure, and field names for beta tables is complete and used in at
        least one federated CLIF project. The <a
          href="/mCIDE"
          class="text-clif-burgundy hover:underline">minimum Common ICU Data Elements (mCIDE)</a
        >
        for category variables is defined.
      </p>

      <!-- ADT Table with Updates -->
      <section class="bg-white p-6 rounded-lg shadow-md mb-8">
        <h3 class="text-xl font-bold mb-2 flex items-center">
          ADT
          <Badge type="beta" class="ml-3" />
          <span class="ml-2 bg-green-100 text-green-800 text-sm px-2 py-1 rounded"
            >Updated in v2.1.0</span
          >
        </h3>
        <p class="mb-4 text-gray-700">
          The admission, discharge, and transfer (ADT) table is a start-stop longitudinal dataset
          that contains information about each patient's movement within the hospital. Now includes <code
            class="bg-gray-200 px-1 py-0.5 rounded">location_type</code
          >
          field for ICU categorization.
        </p>

        <div class="bg-green-50 p-4 rounded mb-4">
          <p class="text-sm font-semibold text-green-800">New in v2.1.0:</p>
          <ul class="text-sm text-green-700 mt-2">
            <li>
              • Added <code class="bg-green-200 px-1 py-0.5 rounded">location_type</code> field to categorize
              ICU types
            </li>
            <li>
              • Added <code class="bg-green-200 px-1 py-0.5 rounded">LTACH</code> to hospital_type values
            </li>
          </ul>
        </div>
      </section>

      <!-- New Beta Tables -->
      <div class="space-y-8">
        {
          betaTables.map((table) => (
            <DataTable
              id={table.id}
              name={table.name}
              description={table.description}
              fields={table.fields}
              maturity="beta"
            />
          ))
        }
      </div>

      <!-- CRRT Modalities Table -->
      <section class="mt-8 mb-12">
        <h3 class="text-lg font-semibold mb-4">CRRT Modalities and Parameter Usage</h3>
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Mode</th
                >
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase"
                  >Blood Flow</th
                >
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase"
                  >Pre-filter Fluid</th
                >
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase"
                  >Post-filter Fluid</th
                >
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase"
                  >Dialysate</th
                >
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase"
                  >Ultrafiltration</th
                >
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              <tr>
                <td class="px-4 py-2 font-semibold">SCUF</td>
                <td class="px-4 py-2 text-green-600">Required</td>
                <td class="px-4 py-2 text-gray-400">Not Used</td>
                <td class="px-4 py-2 text-gray-400">Not Used</td>
                <td class="px-4 py-2 text-gray-400">Not Used</td>
                <td class="px-4 py-2 text-green-600">Required</td>
              </tr>
              <tr>
                <td class="px-4 py-2 font-semibold">CVVH</td>
                <td class="px-4 py-2 text-green-600">Required</td>
                <td class="px-4 py-2 text-green-600">Required</td>
                <td class="px-4 py-2 text-green-600">Required</td>
                <td class="px-4 py-2 text-gray-400">Not Used</td>
                <td class="px-4 py-2 text-green-600">Required</td>
              </tr>
              <tr>
                <td class="px-4 py-2 font-semibold">CVVHD</td>
                <td class="px-4 py-2 text-green-600">Required</td>
                <td class="px-4 py-2 text-gray-400">Not Used</td>
                <td class="px-4 py-2 text-gray-400">Not Used</td>
                <td class="px-4 py-2 text-green-600">Required</td>
                <td class="px-4 py-2 text-green-600">Required</td>
              </tr>
              <tr>
                <td class="px-4 py-2 font-semibold">CVVHDF</td>
                <td class="px-4 py-2 text-green-600">Required</td>
                <td class="px-4 py-2 text-green-600">Required</td>
                <td class="px-4 py-2 text-green-600">Required</td>
                <td class="px-4 py-2 text-green-600">Required</td>
                <td class="px-4 py-2 text-green-600">Required</td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="mt-4 text-sm text-gray-600">
          <p><strong>SCUF:</strong> Slow Continuous Ultrafiltration</p>
          <p><strong>CVVH:</strong> Continuous Veno-Venous Hemofiltration</p>
          <p><strong>CVVHD:</strong> Continuous Veno-Venous Hemodialysis</p>
          <p><strong>CVVHDF:</strong> Continuous Veno-Venous Hemodiafiltration</p>
        </div>
      </section>

      <h2 class="text-2xl font-bold text-clif-burgundy mt-12 mb-4">
        Existing Beta Tables (from v2.0.0)
      </h2>
      <p class="mb-6">The following tables remain in Beta status with the updates noted above:</p>
      <ul class="list-disc list-inside space-y-2 text-gray-700 ml-4">
        <li>ADT (with new location_type field)</li>
        <li>Hospitalization (with finalized admission_type_category)</li>
        <li>Labs</li>
        <li>Medication Admin Continuous</li>
        <li>Patient (with finalized language_category)</li>
        <li>Patient Assessments</li>
        <li>Position</li>
        <li>Respiratory Support</li>
        <li>Vitals</li>
      </ul>

      <h2 class="text-2xl font-bold text-clif-burgundy mt-12 mb-4">Concept Tables</h2>
      <p class="mb-6">These tables remain in concept phase with draft structures:</p>
      <div class="bg-gray-100 p-6 rounded-lg">
        <p class="text-gray-700">
          Concept tables include: Diagnosis, Encounters, Imaging, Intake Output, Lines, Medication
          Admin, Medication Admin MAR, Microbiology Cultures, Monitoring, Procedures, Procedures
          ECMO, Procedures ICD, Renal Replacement Therapy (other modalities), and Surgical Case
          Summary.
        </p>
      </div>

      <div class="mt-12 flex justify-between items-center">
        <a href="/data-dictionary" class="text-clif-burgundy hover:underline">
          ← View Current Version (v2.0.0)
        </a>
        <a href="/data-dictionary/change-log" class="text-clif-burgundy hover:underline">
          View Change Log →
        </a>
      </div>
    </div>
  </div>
</BaseLayout>
