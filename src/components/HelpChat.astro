---
// src/components/HelpChat.astro
// Help widget for reporting issues and asking questions

interface Props {
  githubRepo: string;
  defaultAssignee?: string;
}

const { githubRepo, defaultAssignee = 'deetherese' } = Astro.props;
---

<!-- Floating Help Button -->
<button
  id="help-chat-toggle"
  class="fixed bottom-6 right-6 w-16 h-16 bg-clif-burgundy hover:bg-clif-burgundy/90 text-white rounded-full shadow-lg flex items-center justify-center transition-all duration-300 z-50"
  aria-label="Need help? Report an issue"
  title="Need help? Report an issue"
>
  <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <circle cx="12" cy="12" r="10"/>
    <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
    <path d="M12 17h.01"/>
  </svg>
</button>

<!-- Help Panel -->
<div
  id="help-chat-panel"
  class="fixed bottom-6 right-6 w-[400px] max-w-[calc(100vw-3rem)] bg-white rounded-xl shadow-2xl flex flex-col z-50 hidden"
  data-pagefind-ignore
>
  <!-- Header -->
  <div class="bg-clif-burgundy text-white p-4 rounded-t-xl flex items-center justify-between">
    <div class="flex items-center gap-3">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="10"/>
        <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
        <path d="M12 17h.01"/>
      </svg>
      <span class="font-semibold text-lg">Need Help?</span>
    </div>
    <button id="help-chat-close" class="hover:bg-white/20 p-1 rounded transition-colors" aria-label="Close">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="18" y1="6" x2="6" y2="18"/>
        <line x1="6" y1="6" x2="18" y2="18"/>
      </svg>
    </button>
  </div>

  <!-- Content -->
  <div class="p-4 overflow-y-auto max-h-[70vh]">
    <p class="text-gray-600 mb-4 text-sm">Can't find what you need or have a question? Submit an issue and we'll help you out.</p>

    <form id="report-issue-form" class="space-y-4">
      <input type="hidden" id="github-repo" value={githubRepo} />

      <div>
        <label for="issue-type" class="block text-sm font-medium text-gray-700 mb-1">
          Issue Type
        </label>
        <select
          id="issue-type"
          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-clif-burgundy focus:border-transparent text-gray-900 text-sm"
        >
          <option value="question">Question</option>
          <option value="bug">Bug / Error in Documentation</option>
          <option value="enhancement">Suggestion / Enhancement</option>
          <option value="clarification">Needs Clarification</option>
        </select>
      </div>

      <div>
        <label for="issue-description" class="block text-sm font-medium text-gray-700 mb-1">
          Description <span class="text-red-500">*</span>
        </label>
        <textarea
          id="issue-description"
          required
          rows="4"
          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-clif-burgundy focus:border-transparent text-gray-900 resize-none text-sm"
          placeholder="Describe your question or issue..."
        ></textarea>
      </div>

      <div>
        <label for="etl-table" class="block text-sm font-medium text-gray-700 mb-1">
          Related ETL Table (optional)
        </label>
        <select
          id="etl-table"
          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-clif-burgundy focus:border-transparent text-gray-900 text-sm"
        >
          <option value="">-- Select a table --</option>
          <option value="adt">adt</option>
          <option value="code_status">code_status</option>
          <option value="crrt_therapy">crrt_therapy</option>
          <option value="hospital_diagnosis">hospital_diagnosis</option>
          <option value="hospitalization">hospitalization</option>
          <option value="labs">labs</option>
          <option value="medication_admin_continuous">medication_admin_continuous</option>
          <option value="medication_admin_intermittent">medication_admin_intermittent</option>
          <option value="patient">patient</option>
          <option value="patient_assessments">patient_assessments</option>
          <option value="patient_procedures">patient_procedures</option>
          <option value="position">position</option>
          <option value="respiratory_support">respiratory_support</option>
          <option value="vitals">vitals</option>
        </select>
      </div>

      <p class="text-xs text-gray-500">You'll be redirected to GitHub to submit. Sign in if prompted.</p>

      <button
        type="submit"
        class="w-full py-2.5 px-4 bg-clif-burgundy hover:bg-clif-burgundy/90 text-white rounded-lg transition-colors font-medium flex items-center justify-center gap-2 text-sm"
      >
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
        </svg>
        Open Issue on GitHub
      </button>
    </form>
  </div>
</div>

<script is:inline>
document.addEventListener('DOMContentLoaded', function() {
  const toggleBtn = document.getElementById('help-chat-toggle');
  const chatPanel = document.getElementById('help-chat-panel');
  const closeBtn = document.getElementById('help-chat-close');
  const reportForm = document.getElementById('report-issue-form');

  // Toggle panel
  toggleBtn.addEventListener('click', function() {
    chatPanel.classList.toggle('hidden');
    toggleBtn.classList.toggle('hidden');
  });

  // Close panel
  closeBtn.addEventListener('click', function() {
    chatPanel.classList.add('hidden');
    toggleBtn.classList.remove('hidden');
  });

  // Submit form - redirect to GitHub
  reportForm.addEventListener('submit', function(e) {
    e.preventDefault();

    const issueType = document.getElementById('issue-type').value;
    const description = document.getElementById('issue-description').value;
    const etlTable = document.getElementById('etl-table').value;
    const repo = document.getElementById('github-repo').value;

    // Build issue title from first line or truncated description
    const firstLine = description.split('\n')[0].substring(0, 60);
    const title = firstLine + (description.length > 60 ? '...' : '');

    // Build issue body
    const issueBody = `## Issue Details

**Type:** ${issueType}
**Page:** ETL Guide
${etlTable ? `**Related Table:** \`${etlTable}\`` : ''}

## Description

${description}

---
*Submitted via ETL Guide Help*`;

    // Build GitHub new issue URL
    const labels = [issueType, 'etl-guide'];
    if (etlTable) labels.push(etlTable);

    const params = new URLSearchParams({
      title: `[${issueType}] ${title}`,
      body: issueBody,
      labels: labels.join(',')
    });

    const githubUrl = `https://github.com/${repo}/issues/new?${params.toString()}`;

    // Open GitHub in new tab
    window.open(githubUrl, '_blank');

    // Reset form and close panel
    reportForm.reset();
    chatPanel.classList.add('hidden');
    toggleBtn.classList.remove('hidden');
  });

  // Close on escape key
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && !chatPanel.classList.contains('hidden')) {
      chatPanel.classList.add('hidden');
      toggleBtn.classList.remove('hidden');
    }
  });
});
</script>
