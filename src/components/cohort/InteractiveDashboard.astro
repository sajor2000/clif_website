---
import { parseConsortiumCSV, groupCharacteristics } from '../../utils/csvParser';
import { readFile } from 'fs/promises';
import { join } from 'path';

// Read and parse the CSV file at build time
const csvPath = join(process.cwd(), 'src', 'data', 'consortium_t1_by_year_site_1113.csv');
const csvContent = await readFile(csvPath, 'utf-8');
const data = parseConsortiumCSV(csvContent);
const groupedChars = groupCharacteristics(data);

// Convert to JSON for client-side use
const dataJson = JSON.stringify({
  allSites: data.allSites,
  allYears: data.allYears,
  characteristics: data.characteristics.map(c => ({
    variable: c.variable,
    sites: Object.fromEntries(
      Array.from(c.sites.entries()).map(([site, yearMap]) => [
        site,
        Object.fromEntries(yearMap)
      ])
    )
  })),
  siteYearData: data.siteYearData.map(d => ({
    site: d.site,
    year: d.year,
    characteristics: Object.fromEntries(d.characteristics)
  }))
});

const categories = Array.from(groupedChars.keys());
---

<div class="interactive-dashboard bg-white rounded-2xl shadow-xl p-6 md:p-8">
  <!-- Dashboard Header -->
  <div class="mb-8">
    <h2 class="text-3xl font-bold text-gray-800 mb-2">Interactive Data Explorer</h2>
    <p class="text-gray-600 mb-3">
      Explore consortium data across {data.allSites.length} institutions and {data.allYears.length} years.
      Use the filters below to customize your view.
    </p>
    <div class="bg-blue-50 border-l-4 border-blue-400 p-3 rounded">
      <p class="text-sm text-blue-800">
        <strong>Privacy Notice:</strong> To protect patient privacy, characteristics with values where n &lt; 10 are automatically excluded from display and export.
      </p>
    </div>
  </div>

  <!-- Filter Controls -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
    <!-- Site Filter -->
    <div>
      <label class="block text-sm font-semibold text-gray-700 mb-2">
        Select Institutions
      </label>
      <div class="relative">
        <button
          id="site-filter-toggle"
          class="w-full bg-white border-2 border-gray-300 rounded-lg px-4 py-2 text-left flex items-center justify-between hover:border-clif-burgundy transition-colors"
        >
          <span id="site-filter-text" class="text-gray-700">All Sites</span>
          <svg class="w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
          </svg>
        </button>
        <div
          id="site-filter-dropdown"
          class="hidden absolute z-50 mt-2 w-full bg-white border-2 border-gray-200 rounded-lg shadow-lg max-h-64 overflow-y-auto"
        >
          <div class="p-2">
            <label class="flex items-center px-3 py-2 hover:bg-gray-50 rounded cursor-pointer">
              <input
                type="checkbox"
                id="site-all"
                class="site-checkbox w-4 h-4 text-clif-burgundy border-gray-300 rounded focus:ring-clif-burgundy"
                checked
              />
              <span class="ml-2 text-sm text-gray-700 font-semibold">All Sites</span>
            </label>
            {data.allSites.map(site => (
              <label class="flex items-center px-3 py-2 hover:bg-gray-50 rounded cursor-pointer">
                <input
                  type="checkbox"
                  class="site-checkbox w-4 h-4 text-clif-burgundy border-gray-300 rounded focus:ring-clif-burgundy"
                  value={site}
                  checked
                />
                <span class="ml-2 text-sm text-gray-700">{site}</span>
              </label>
            ))}
          </div>
        </div>
      </div>
    </div>

    <!-- Year Filter -->
    <div>
      <label class="block text-sm font-semibold text-gray-700 mb-2">
        Select Years
      </label>
      <div class="relative">
        <button
          id="year-filter-toggle"
          class="w-full bg-white border-2 border-gray-300 rounded-lg px-4 py-2 text-left flex items-center justify-between hover:border-clif-burgundy transition-colors"
        >
          <span id="year-filter-text" class="text-gray-700">All Years</span>
          <svg class="w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
          </svg>
        </button>
        <div
          id="year-filter-dropdown"
          class="hidden absolute z-50 mt-2 w-full bg-white border-2 border-gray-200 rounded-lg shadow-lg max-h-64 overflow-y-auto"
        >
          <div class="p-2">
            <label class="flex items-center px-3 py-2 hover:bg-gray-50 rounded cursor-pointer">
              <input
                type="checkbox"
                id="year-all"
                class="year-checkbox w-4 h-4 text-clif-burgundy border-gray-300 rounded focus:ring-clif-burgundy"
                checked
              />
              <span class="ml-2 text-sm text-gray-700 font-semibold">All Years</span>
            </label>
            {data.allYears.map(year => (
              <label class="flex items-center px-3 py-2 hover:bg-gray-50 rounded cursor-pointer">
                <input
                  type="checkbox"
                  class="year-checkbox w-4 h-4 text-clif-burgundy border-gray-300 rounded focus:ring-clif-burgundy"
                  value={year}
                  checked
                />
                <span class="ml-2 text-sm text-gray-700">{year}</span>
              </label>
            ))}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- View Toggle -->
  <div class="flex items-center justify-between mb-6 pb-6 border-b-2 border-gray-200">
    <div class="flex gap-2">
      <button
        id="view-charts"
        class="px-6 py-2 bg-clif-burgundy text-white rounded-lg font-semibold hover:bg-clif-burgundy-dark transition-colors"
      >
        Charts
      </button>
      <button
        id="view-table"
        class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 transition-colors"
      >
        Table
      </button>
    </div>

    <!-- Export Button -->
    <button
      id="export-data"
      class="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition-colors"
    >
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
      </svg>
      Export CSV
    </button>
  </div>

  <!-- Charts View -->
  <div id="charts-view" class="flex gap-6">
    <!-- Left Sidebar - Characteristic Categories -->
    <div class="w-80 flex-shrink-0">
      <div class="bg-white border-2 border-gray-200 rounded-lg overflow-hidden sticky top-4">
        <!-- Search Box -->
        <div class="p-4 border-b border-gray-200">
          <input
            type="text"
            id="characteristic-search"
            placeholder="Search for a filter"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:border-clif-burgundy focus:ring-2 focus:ring-clif-burgundy focus:ring-opacity-50"
          />
        </div>

        <!-- Categories List -->
        <div id="categories-list" class="max-h-[600px] overflow-y-auto">
          <!-- Categories will be populated by JavaScript -->
        </div>
      </div>
    </div>

    <!-- Right Content Area -->
    <div class="flex-1 space-y-6">
      <!-- Chart Builder Controls -->
      <div class="bg-gray-50 rounded-lg p-6">
        <h3 class="text-lg font-bold text-gray-800 mb-4">Chart Builder</h3>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <!-- Chart Type Selector -->
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">Chart Type</label>
            <select
              id="chart-type-select"
              class="w-full bg-white border-2 border-gray-300 rounded-lg px-3 py-2 text-sm text-gray-700 focus:border-clif-burgundy focus:ring-2 focus:ring-clif-burgundy focus:ring-opacity-50"
            >
              <option value="bar">Bar Chart</option>
              <option value="line">Line Chart</option>
              <option value="horizontalBar">Horizontal Bar</option>
              <option value="pie">Pie Chart</option>
              <option value="doughnut">Doughnut Chart</option>
            </select>
          </div>

          <!-- X-Axis Selector -->
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">Group By</label>
            <select
              id="chart-xaxis-select"
              class="w-full bg-white border-2 border-gray-300 rounded-lg px-3 py-2 text-sm text-gray-700 focus:border-clif-burgundy focus:ring-2 focus:ring-clif-burgundy focus:ring-opacity-50"
            >
              <option value="site">Site</option>
              <option value="year">Year</option>
              <option value="site-year">Site-Year</option>
            </select>
          </div>

          <!-- Generate Button -->
          <div class="flex items-end">
            <button
              id="generate-chart-btn"
              class="w-full px-4 py-2 bg-clif-burgundy text-white rounded-lg font-semibold hover:bg-clif-burgundy-dark transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed"
              disabled
            >
              Generate Chart
            </button>
          </div>
        </div>

        <!-- Selected Characteristic Display -->
        <div id="selected-characteristic-display" class="mt-4 hidden">
          <div class="flex items-center gap-2 text-sm text-gray-600">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
            </svg>
            <span>Selected: <strong id="selected-characteristic-name"></strong></span>
          </div>
        </div>
      </div>

    <!-- Chart Display Area -->
    <div id="custom-chart-container" class="bg-white rounded-lg p-6 border-2 border-gray-200 hidden">
      <div class="flex items-center justify-between mb-4">
        <h3 id="custom-chart-title" class="text-lg font-bold text-gray-800"></h3>
        <button
          id="clear-chart-btn"
          class="px-3 py-1 bg-gray-200 text-gray-700 rounded text-sm hover:bg-gray-300 transition-colors"
        >
          Clear
        </button>
      </div>
      <div class="relative" style="height: 400px;">
        <canvas id="custom-chart"></canvas>
      </div>
    </div>

    <!-- Instructions (shown when no chart) -->
    <div id="chart-instructions" class="bg-gray-50 rounded-lg p-8 text-center">
      <svg class="w-16 h-16 mx-auto text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
      </svg>
      <h3 class="text-xl font-bold text-gray-700 mb-2">Create Your Custom Chart</h3>
      <p class="text-gray-600">
        Select a characteristic from the sidebar, choose a chart type and grouping option, then click "Generate Chart" to visualize your data.
      </p>
    </div>
    </div>
  </div>

  <!-- Table View -->
  <div id="table-view" class="hidden">
    <!-- Search Box -->
    <div class="mb-4">
      <input
        type="text"
        id="table-search"
        placeholder="Search characteristics..."
        class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-clif-burgundy focus:ring-2 focus:ring-clif-burgundy focus:ring-opacity-50"
      />
    </div>

    <!-- Data Table -->
    <div class="overflow-x-auto">
      <table id="data-table" class="w-full border-collapse">
        <thead class="bg-clif-burgundy text-white sticky top-0">
          <tr>
            <th class="px-4 py-3 text-left font-semibold">Characteristic</th>
            <th class="px-4 py-3 text-left font-semibold">Site</th>
            <th class="px-4 py-3 text-left font-semibold">Year</th>
            <th class="px-4 py-3 text-left font-semibold">Value</th>
          </tr>
        </thead>
        <tbody id="table-body" class="divide-y divide-gray-200">
          <!-- Populated by JavaScript -->
        </tbody>
      </table>
    </div>
  </div>
</div>

<script define:vars={{ dataJson }}>
  // Parse the data
  const consortiumData = JSON.parse(dataJson);

  // State management
  let selectedSites = [...consortiumData.allSites];
  let selectedYears = [...consortiumData.allYears];
  let currentView = 'charts';

  // Chart instances
  let charts = {};

  // Initialize on page load
  document.addEventListener('DOMContentLoaded', () => {
    initializeFilters();
    initializeViewToggle();
    initializeExport();
    updateDashboard();
  });

  function initializeFilters() {
    // Site filter
    const siteToggle = document.getElementById('site-filter-toggle');
    const siteDropdown = document.getElementById('site-filter-dropdown');
    const siteAll = document.getElementById('site-all');
    const siteCheckboxes = document.querySelectorAll('.site-checkbox:not(#site-all)');

    siteToggle?.addEventListener('click', (e) => {
      e.stopPropagation();
      siteDropdown?.classList.toggle('hidden');
      document.getElementById('year-filter-dropdown')?.classList.add('hidden');
    });

    siteAll?.addEventListener('change', (e) => {
      const checked = e.target.checked;
      siteCheckboxes.forEach(cb => cb.checked = checked);
      updateSelectedSites();
    });

    siteCheckboxes.forEach(cb => {
      cb.addEventListener('change', () => {
        updateSelectedSites();
      });
    });

    // Year filter
    const yearToggle = document.getElementById('year-filter-toggle');
    const yearDropdown = document.getElementById('year-filter-dropdown');
    const yearAll = document.getElementById('year-all');
    const yearCheckboxes = document.querySelectorAll('.year-checkbox:not(#year-all)');

    yearToggle?.addEventListener('click', (e) => {
      e.stopPropagation();
      yearDropdown?.classList.toggle('hidden');
      document.getElementById('site-filter-dropdown')?.classList.add('hidden');
    });

    yearAll?.addEventListener('change', (e) => {
      const checked = e.target.checked;
      yearCheckboxes.forEach(cb => cb.checked = checked);
      updateSelectedYears();
    });

    yearCheckboxes.forEach(cb => {
      cb.addEventListener('change', () => {
        updateSelectedYears();
      });
    });

    // Close dropdowns when clicking outside
    document.addEventListener('click', () => {
      siteDropdown?.classList.add('hidden');
      yearDropdown?.classList.add('hidden');
    });
  }

  function updateSelectedSites() {
    const checkboxes = document.querySelectorAll('.site-checkbox:not(#site-all)');
    selectedSites = Array.from(checkboxes)
      .filter(cb => cb.checked)
      .map(cb => cb.value);

    const siteAll = document.getElementById('site-all');
    if (siteAll) {
      siteAll.checked = selectedSites.length === consortiumData.allSites.length;
    }

    let text;
    if (selectedSites.length === consortiumData.allSites.length) {
      text = 'All Sites';
    } else if (selectedSites.length === 1) {
      text = selectedSites[0];
    } else if (selectedSites.length <= 3) {
      text = selectedSites.join(', ');
    } else {
      text = `${selectedSites.length} Sites`;
    }
    document.getElementById('site-filter-text').textContent = text;

    updateDashboard();
  }

  function updateSelectedYears() {
    const checkboxes = document.querySelectorAll('.year-checkbox:not(#year-all)');
    selectedYears = Array.from(checkboxes)
      .filter(cb => cb.checked)
      .map(cb => cb.value);

    const yearAll = document.getElementById('year-all');
    if (yearAll) {
      yearAll.checked = selectedYears.length === consortiumData.allYears.length;
    }

    let text;
    if (selectedYears.length === consortiumData.allYears.length) {
      text = 'All Years';
    } else if (selectedYears.length === 1) {
      text = selectedYears[0];
    } else if (selectedYears.length <= 3) {
      text = selectedYears.join(', ');
    } else {
      text = `${selectedYears.length} Years`;
    }
    document.getElementById('year-filter-text').textContent = text;

    updateDashboard();
  }

  function initializeViewToggle() {
    const chartsBtn = document.getElementById('view-charts');
    const tableBtn = document.getElementById('view-table');
    const chartsView = document.getElementById('charts-view');
    const tableView = document.getElementById('table-view');

    chartsBtn?.addEventListener('click', () => {
      currentView = 'charts';
      chartsBtn.classList.remove('bg-gray-200', 'text-gray-700');
      chartsBtn.classList.add('bg-clif-burgundy', 'text-white');
      tableBtn?.classList.remove('bg-clif-burgundy', 'text-white');
      tableBtn?.classList.add('bg-gray-200', 'text-gray-700');
      chartsView?.classList.remove('hidden');
      tableView?.classList.add('hidden');
    });

    tableBtn?.addEventListener('click', () => {
      currentView = 'table';
      tableBtn.classList.remove('bg-gray-200', 'text-gray-700');
      tableBtn.classList.add('bg-clif-burgundy', 'text-white');
      chartsBtn?.classList.remove('bg-clif-burgundy', 'text-white');
      chartsBtn?.classList.add('bg-gray-200', 'text-gray-700');
      tableView?.classList.remove('hidden');
      chartsView?.classList.add('hidden');
      updateTable();
    });

    // Table search
    const searchInput = document.getElementById('table-search');
    searchInput?.addEventListener('input', () => {
      updateTable();
    });
  }

  function initializeExport() {
    const exportBtn = document.getElementById('export-data');
    exportBtn?.addEventListener('click', exportToCSV);
  }

  function updateDashboard() {
    if (currentView === 'charts') {
      updateCharts();
    } else {
      updateTable();
    }
  }

  function getFilteredData() {
    return consortiumData.siteYearData.filter(d => {
      return selectedSites.includes(d.site) && selectedYears.includes(d.year);
    });
  }

  function extractNumber(value) {
    if (!value) return 0;
    const match = value.match(/^[\d,]+/);
    return match ? parseInt(match[0].replace(/,/g, ''), 10) : 0;
  }

  // Helper function to extract numeric value from string like "164 (0.1%)" or "68,359 (57.6%)" or "66 [54, 76]"
  function getNumeric(value) {
    if (typeof value !== 'string') return null;
    // Match patterns like: "66 [54, 76]" or "164 (0.1%)" or "68,359 (57.6%)"
    const match = value.match(/^\s*([-\d,\.]+)\s*(?:\([^\)]*\)|\[[^\]]*\])?\s*$/);
    if (match) {
      const numStr = match[1].replace(/,/g, '');
      try {
        return parseFloat(numStr);
      } catch {
        return null;
      }
    }
    return null;
  }

  // Check if value has IQR pattern [x, y]
  function valueHasIQR(value) {
    if (typeof value !== 'string') return false;
    return /\[.*?,.*?\]/.test(value);
  }

  // Extract median, q1, q3 from "62 [53, 71]"
  function extractMedianIQR(value) {
    if (typeof value !== 'string') return null;
    const match = value.match(/^\s*([-\d\.]+)\s*\[\s*([-\d\.]+)\s*,\s*([-\d\.]+)\s*\]/);
    if (match) {
      try {
        return {
          median: parseFloat(match[1]),
          q1: parseFloat(match[2]),
          q3: parseFloat(match[3])
        };
      } catch {
        return null;
      }
    }
    return null;
  }

  // Calculate weighted median
  function weightedMedian(data, weights) {
    if (data.length === 0) return null;

    // Create array of [value, weight] pairs and sort by value
    const pairs = data.map((val, i) => [val, weights[i]]);
    pairs.sort((a, b) => a[0] - b[0]);

    const sortedData = pairs.map(p => p[0]);
    const sortedWeights = pairs.map(p => p[1]);

    // Calculate cumulative weights
    const totalWeight = sortedWeights.reduce((sum, w) => sum + w, 0);
    const cutoff = totalWeight / 2;

    let cumSum = 0;
    for (let i = 0; i < sortedWeights.length; i++) {
      cumSum += sortedWeights[i];
      if (cumSum >= cutoff) {
        return sortedData[i];
      }
    }

    return sortedData[sortedData.length - 1];
  }

  // Format number with optional decimal places
  function formatNumber(num) {
    return Number.isInteger(num) ? num.toString() : num.toFixed(2);
  }

  // Check if a value has n < 10 (for privacy protection)
  function hasSmallN(value) {
    if (typeof value !== 'string') return false;

    // Extract the first numeric value (before parentheses or brackets)
    const numericMatch = value.match(/^\s*([\d,]+)/);
    if (numericMatch) {
      const num = parseInt(numericMatch[1].replace(/,/g, ''), 10);
      return num < 10;
    }

    return false;
  }

  // Check if any value in a row has n < 10
  function rowHasSmallN(values) {
    return values.some(v => hasSmallN(v));
  }

  // Aggregate values across multiple site-years
  function aggregateConsortiumValue(variable, siteYearData) {
    const values = siteYearData.map(d => d.value);

    // Check if any value has IQR - if so, handle as median aggregation
    if (values.some(v => valueHasIQR(v))) {
      const extracted = values.map(v => extractMedianIQR(v)).filter(e => e !== null);

      if (extracted.length === 0) return '-';

      // Determine weights based on variable
      const isAgeVariable = variable.toLowerCase().includes('age at admission');
      const weights = siteYearData.map((d, i) => {
        if (extractMedianIQR(values[i]) === null) return 0;

        if (isAgeVariable) {
          return d.nUniquePatients || 0;
        } else {
          return d.nEncounterBlocks || 0;
        }
      }).filter((w, i) => extractMedianIQR(values[i]) !== null);

      // If all weights are 0, use uniform weights
      const totalWeight = weights.reduce((sum, w) => sum + w, 0);
      const finalWeights = totalWeight > 0 ? weights : weights.map(() => 1);

      const medians = extracted.map(e => e.median);
      const q1s = extracted.map(e => e.q1);
      const q3s = extracted.map(e => e.q3);

      const medianWeighted = weightedMedian(medians, finalWeights);
      const q1Min = Math.min(...q1s);
      const q3Max = Math.max(...q3s);

      return `${formatNumber(medianWeighted)} [${formatNumber(q1Min)}, ${formatNumber(q3Max)}]`;
    }

    // Handle numeric values with percentages
    const numbers = values.map(v => getNumeric(v)).filter(n => n !== null);
    if (numbers.length === 0) return '-';

    const sum = numbers.reduce((acc, n) => acc + n, 0);

    // Variables that should NOT have percentages
    const noPercentageVars = [
      'n: encounter blocks',
      'n: unique patients',
      'n: hospitals'
    ];

    const varLower = variable.toLowerCase();
    if (noPercentageVars.some(v => varLower.includes(v.toLowerCase()))) {
      return sum.toLocaleString();
    }

    // Determine denominator
    const mortalityVars = [
      'hospital mortality',
      'discharged to hospice',
      'expired'
    ];

    const usePatientsAsNumerator = (
      varLower.includes('race:') ||
      varLower.includes('ethnicity:') ||
      varLower.includes('sex:') ||
      mortalityVars.some(term => varLower.includes(term))
    );

    // Calculate total denominators
    const totalPatients = siteYearData.reduce((sum, d) => sum + (d.nUniquePatients || 0), 0);
    const totalEncounters = siteYearData.reduce((sum, d) => sum + (d.nEncounterBlocks || 0), 0);

    const denominator = usePatientsAsNumerator ? totalPatients : totalEncounters;

    if (denominator > 0) {
      const percentage = (sum / denominator) * 100;
      return `${sum.toLocaleString()} (${percentage.toFixed(1)}%)`;
    }

    return sum.toLocaleString();
  }

  // Track selected characteristic
  let selectedCharacteristic = null;

  function initializeChartBuilder() {
    // Build the category sidebar
    buildCategorySidebar();

    // Generate chart button
    const generateBtn = document.getElementById('generate-chart-btn');
    generateBtn?.addEventListener('click', generateCustomChart);

    // Clear chart button
    const clearBtn = document.getElementById('clear-chart-btn');
    clearBtn?.addEventListener('click', clearCustomChart);

    // Characteristic search
    const searchInput = document.getElementById('characteristic-search');
    searchInput?.addEventListener('input', (e) => {
      filterCategorySidebar(e.target.value);
    });
  }

  function buildCategorySidebar() {
    const filteredData = getFilteredData();

    // Get all characteristics
    const characteristics = new Set();
    filteredData.forEach(d => {
      Object.keys(d.characteristics).forEach(char => {
        characteristics.add(char);
      });
    });

    // Group characteristics by category
    const categories = {
      'Demographics': [],
      'Encounter Information': [],
      'Clinical Outcomes': [],
      'Comorbidities': [],
      'Severity Scores': [],
      'Respiratory Support': [],
      'Cardiovascular Support': [],
      'Renal Support': [],
      'Counts': [],
      'Other': []
    };

    characteristics.forEach(char => {
      const charTrimmed = char.trim();
      let categorized = false;

      // Demographics
      if (charTrimmed.includes('Age at admission') ||
          charTrimmed.includes('Race:') ||
          charTrimmed.includes('Ethnicity:') ||
          charTrimmed.includes('Sex:')) {
        categories['Demographics'].push(charTrimmed);
        categorized = true;
      }
      // Encounter Information
      else if (charTrimmed.includes('Encounter Types') ||
               charTrimmed.includes('ICU encounters') ||
               charTrimmed.includes('Advanced respiratory support') ||
               charTrimmed.includes('Vasoactive support') ||
               charTrimmed.includes('Other critically ill') ||
               charTrimmed.includes('admission location:') ||
               charTrimmed.includes('Admission type:')) {
        categories['Encounter Information'].push(charTrimmed);
        categorized = true;
      }
      // Clinical Outcomes
      else if (charTrimmed.includes('Hospital mortality') ||
               charTrimmed.includes('Discharged to hospice') ||
               charTrimmed.includes('Expired') ||
               charTrimmed.includes('length of stay')) {
        categories['Clinical Outcomes'].push(charTrimmed);
        categorized = true;
      }
      // Comorbidities
      else if (charTrimmed.includes('Charlson') ||
               charTrimmed.includes('Comorbidities') ||
               charTrimmed.includes('Heart Failure') ||
               charTrimmed.includes('Renal Disease') ||
               charTrimmed.includes('Pulmonary Disease') ||
               charTrimmed.includes('Cerebrovascular') ||
               charTrimmed.includes('Cancer') ||
               charTrimmed.includes('Metastatic') ||
               charTrimmed.includes('Vascular Disease') ||
               charTrimmed.includes('Myocardial') ||
               charTrimmed.includes('Dementia') ||
               charTrimmed.includes('Liver Disease') ||
               charTrimmed.includes('Hemiplegia') ||
               charTrimmed.includes('Connective Tissue') ||
               charTrimmed.includes('Peptic Ulcer') ||
               charTrimmed.includes('Aids')) {
        categories['Comorbidities'].push(charTrimmed);
        categorized = true;
      }
      // Severity Scores
      else if (charTrimmed.includes('SOFA') ||
               charTrimmed.includes('P/F ratio')) {
        categories['Severity Scores'].push(charTrimmed);
        categorized = true;
      }
      // Respiratory Support
      else if (charTrimmed.includes('mechanical ventilation') ||
               charTrimmed.includes('IMV') ||
               charTrimmed.includes('ventilator mode') ||
               charTrimmed.includes('FiO2') ||
               charTrimmed.includes('PEEP') ||
               charTrimmed.includes('Respiratory rate') ||
               charTrimmed.includes('Tidal volume')) {
        categories['Respiratory Support'].push(charTrimmed);
        categorized = true;
      }
      // Cardiovascular Support
      else if (charTrimmed.includes('Vasopressor') ||
               charTrimmed.includes('Norepinephrine') ||
               charTrimmed.includes('Epinephrine') ||
               charTrimmed.includes('Phenylephrine') ||
               charTrimmed.includes('Vasopressin') ||
               charTrimmed.includes('Dopamine') ||
               charTrimmed.includes('Dobutamine')) {
        categories['Cardiovascular Support'].push(charTrimmed);
        categorized = true;
      }
      // Renal Support
      else if (charTrimmed.includes('CRRT')) {
        categories['Renal Support'].push(charTrimmed);
        categorized = true;
      }
      // Counts
      else if (charTrimmed.startsWith('N:')) {
        categories['Counts'].push(charTrimmed);
        categorized = true;
      }

      if (!categorized) {
        categories['Other'].push(charTrimmed);
      }
    });

    // Build the sidebar HTML
    const categoriesList = document.getElementById('categories-list');
    if (!categoriesList) return;

    categoriesList.innerHTML = '';

    Object.entries(categories).forEach(([categoryName, chars]) => {
      if (chars.length === 0) return; // Skip empty categories

      const categoryDiv = document.createElement('div');
      categoryDiv.className = 'category-section border-b border-gray-200';

      // Category header (collapsible)
      const header = document.createElement('button');
      header.className = 'category-header w-full flex items-center justify-between p-3 hover:bg-gray-50 transition-colors text-left';
      header.innerHTML = `
        <span class="font-semibold text-gray-800 text-sm">${categoryName}</span>
        <svg class="chevron w-4 h-4 text-gray-500 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
        </svg>
      `;

      // Characteristics list
      const charList = document.createElement('div');
      charList.className = 'characteristic-list';
      chars.sort().forEach(char => {
        const charItem = document.createElement('button');
        charItem.className = 'characteristic-item w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-clif-burgundy hover:bg-opacity-10 hover:text-clif-burgundy transition-colors';
        charItem.dataset.characteristic = char;
        charItem.textContent = char;
        charItem.addEventListener('click', () => selectCharacteristic(char, charItem));
        charList.appendChild(charItem);
      });

      // Toggle collapse on header click
      header.addEventListener('click', () => {
        const isExpanded = charList.style.display !== 'none';
        charList.style.display = isExpanded ? 'none' : 'block';
        header.querySelector('.chevron').style.transform = isExpanded ? 'rotate(-90deg)' : 'rotate(0deg)';
      });

      categoryDiv.appendChild(header);
      categoryDiv.appendChild(charList);
      categoriesList.appendChild(categoryDiv);
    });
  }

  function selectCharacteristic(characteristic, element) {
    selectedCharacteristic = characteristic;

    // Update UI - remove previous selection
    document.querySelectorAll('.characteristic-item').forEach(item => {
      item.classList.remove('bg-clif-burgundy', 'bg-opacity-20', 'text-clif-burgundy', 'font-semibold');
    });

    // Highlight selected item
    element.classList.add('bg-clif-burgundy', 'bg-opacity-20', 'text-clif-burgundy', 'font-semibold');

    // Show selected characteristic
    const display = document.getElementById('selected-characteristic-display');
    const nameEl = document.getElementById('selected-characteristic-name');
    if (display && nameEl) {
      nameEl.textContent = characteristic;
      display.classList.remove('hidden');
    }

    // Enable generate button
    const generateBtn = document.getElementById('generate-chart-btn');
    if (generateBtn) {
      generateBtn.disabled = false;
    }
  }

  function filterCategorySidebar(searchTerm) {
    const term = searchTerm.toLowerCase();
    const categories = document.querySelectorAll('.category-section');

    categories.forEach(category => {
      const characteristics = category.querySelectorAll('.characteristic-item');
      let hasVisibleChar = false;

      characteristics.forEach(char => {
        const text = char.textContent.toLowerCase();
        if (text.includes(term)) {
          char.style.display = 'block';
          hasVisibleChar = true;
        } else {
          char.style.display = 'none';
        }
      });

      // Show/hide category based on whether it has visible characteristics
      category.style.display = hasVisibleChar ? 'block' : 'none';

      // If searching, expand categories with matches
      if (term && hasVisibleChar) {
        const charList = category.querySelector('.characteristic-list');
        const chevron = category.querySelector('.chevron');
        charList.style.display = 'block';
        chevron.style.transform = 'rotate(0deg)';
      }
    });
  }

  function generateCustomChart() {
    const chartType = document.getElementById('chart-type-select')?.value;
    const characteristic = selectedCharacteristic;
    const groupBy = document.getElementById('chart-xaxis-select')?.value;

    if (!characteristic) {
      alert('Please select a characteristic from the sidebar to visualize.');
      return;
    }

    const filteredData = getFilteredData();

    // Debug logging
    console.log('Selected characteristic:', characteristic);
    console.log('Filtered data length:', filteredData.length);
    console.log('First filtered data item:', filteredData[0]);
    if (filteredData.length > 0) {
      console.log('Characteristic value:', filteredData[0].characteristics[characteristic]);
      console.log('All characteristics for first item:', Object.keys(filteredData[0].characteristics));
    }

    // Collect data based on grouping
    const chartData = {};

    // Check if this is a median/IQR characteristic
    const isMedianChar = characteristic.toLowerCase().includes('median') ||
                         characteristic.toLowerCase().includes('[q1') ||
                         (filteredData.length > 0 && valueHasIQR(filteredData[0].characteristics[characteristic] || ''));

    filteredData.forEach(d => {
      // Try exact match first, then trimmed match
      let value = d.characteristics[characteristic];

      // If not found, try to find by trimming
      if (!value) {
        const charKey = Object.keys(d.characteristics).find(key =>
          key.trim() === characteristic.trim()
        );
        if (charKey) {
          value = d.characteristics[charKey];
        }
      }

      if (!value) {
        console.log('No value found for characteristic:', characteristic);
        console.log('Available characteristics:', Object.keys(d.characteristics).slice(0, 10));
        return;
      }

      // Skip if has small n (privacy protection)
      if (hasSmallN(value)) return;

      let label;
      if (groupBy === 'site') {
        label = d.site;
      } else if (groupBy === 'year') {
        label = d.year;
      } else {
        label = `${d.site}-${d.year}`;
      }

      // Extract numeric value
      const numValue = getNumeric(value);
      console.log('Label:', label, 'Value:', value, 'NumValue:', numValue, 'IsMedian:', isMedianChar);

      if (numValue !== null) {
        if (isMedianChar) {
          // For median values, don't sum - just take the value (or average if multiple)
          if (!chartData[label]) {
            chartData[label] = { sum: 0, count: 0 };
          }
          chartData[label].sum += numValue;
          chartData[label].count += 1;
          console.log('Added median data for', label, ':', chartData[label]);
        } else {
          // For count values, sum them
          if (!chartData[label]) chartData[label] = 0;
          chartData[label] += numValue;
          console.log('Added count data for', label, ':', chartData[label]);
        }
      } else {
        console.log('numValue is null for:', value);
      }
    });

    console.log('Chart data before averaging:', JSON.parse(JSON.stringify(chartData)));

    // Convert median data to averages
    if (isMedianChar) {
      Object.keys(chartData).forEach(key => {
        chartData[key] = chartData[key].sum / chartData[key].count;
      });
    }

    if (Object.keys(chartData).length === 0) {
      alert(`No data available for "${characteristic}" with the selected filters.\n\nPossible reasons:\n- Not all sites/years have this data point\n- Values may be suppressed for privacy (n < 10)\n- Try selecting different sites or years`);
      return;
    }

    // Destroy existing chart
    if (charts.custom) {
      charts.custom.destroy();
    }

    // Show chart container, hide instructions
    document.getElementById('custom-chart-container')?.classList.remove('hidden');
    document.getElementById('chart-instructions')?.classList.add('hidden');

    // Update title
    const titleEl = document.getElementById('custom-chart-title');
    if (titleEl) {
      titleEl.textContent = `${characteristic} by ${groupBy === 'site' ? 'Site' : groupBy === 'year' ? 'Year' : 'Site-Year'}`;
    }

    // Generate colors
    const labels = Object.keys(chartData);
    const colors = generateChartColors(labels.length);

    // Create chart
    const ctx = document.getElementById('custom-chart');
    if (ctx) {
      const config = {
        type: chartType === 'horizontalBar' ? 'bar' : chartType,
        data: {
          labels: labels,
          datasets: [{
            label: characteristic,
            data: Object.values(chartData),
            backgroundColor: colors.background,
            borderColor: colors.border,
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          indexAxis: chartType === 'horizontalBar' ? 'y' : 'x',
          plugins: {
            legend: {
              display: chartType === 'pie' || chartType === 'doughnut',
              position: 'bottom'
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  let label = context.label || '';
                  if (label) {
                    label += ': ';
                  }
                  label += context.parsed.y !== undefined ? context.parsed.y.toLocaleString() : context.parsed.toLocaleString();
                  return label;
                }
              }
            }
          },
          scales: (chartType === 'pie' || chartType === 'doughnut') ? {} : {
            x: { beginAtZero: true },
            y: { beginAtZero: true }
          }
        }
      };

      charts.custom = new Chart(ctx, config);
    }
  }

  function clearCustomChart() {
    if (charts.custom) {
      charts.custom.destroy();
      charts.custom = null;
    }
    document.getElementById('custom-chart-container')?.classList.add('hidden');
    document.getElementById('chart-instructions')?.classList.remove('hidden');

    // Clear selected characteristic
    selectedCharacteristic = null;
    document.querySelectorAll('.characteristic-item').forEach(item => {
      item.classList.remove('bg-clif-burgundy', 'bg-opacity-20', 'text-clif-burgundy', 'font-semibold');
    });
    document.getElementById('selected-characteristic-display')?.classList.add('hidden');

    // Disable generate button
    const generateBtn = document.getElementById('generate-chart-btn');
    if (generateBtn) {
      generateBtn.disabled = true;
    }
  }

  function generateChartColors(count) {
    const baseColors = [
      'rgba(139, 0, 0, 0.7)',      // burgundy
      'rgba(59, 130, 246, 0.7)',   // blue
      'rgba(16, 185, 129, 0.7)',   // green
      'rgba(245, 158, 11, 0.7)',   // amber
      'rgba(168, 85, 247, 0.7)',   // purple
      'rgba(236, 72, 153, 0.7)',   // pink
      'rgba(239, 68, 68, 0.7)',    // red
      'rgba(14, 165, 233, 0.7)',   // sky
      'rgba(34, 197, 94, 0.7)',    // emerald
      'rgba(251, 146, 60, 0.7)',   // orange
    ];

    const background = [];
    const border = [];

    for (let i = 0; i < count; i++) {
      const color = baseColors[i % baseColors.length];
      background.push(color);
      border.push(color.replace('0.7', '1'));
    }

    return { background, border };
  }

  function updateCharts() {
    // This is called when filters change - reinitialize the chart builder
    initializeChartBuilder();
  }

  function updateTable() {
    const filteredData = getFilteredData();
    const searchTerm = document.getElementById('table-search')?.value.toLowerCase() || '';
    const tbody = document.getElementById('table-body');
    const thead = document.querySelector('#data-table thead tr');

    if (!tbody || !thead) return;

    // Check if we should pivot
    const shouldPivotBySites = selectedYears.length === 1 && selectedSites.length > 1;
    const shouldPivotByYears = selectedSites.length === 1 && selectedYears.length > 1;
    const shouldPivotSingle = selectedSites.length === 1 && selectedYears.length === 1;

    if (shouldPivotSingle) {
      // Pivot mode: Single site, single year - just Characteristic and Site columns
      const site = selectedSites[0];
      const year = selectedYears[0];

      // Update table headers
      thead.innerHTML = `
        <th class="px-4 py-3 text-left font-semibold">Characteristic</th>
        <th class="px-4 py-3 text-left font-semibold">${site}</th>
      `;

      // Populate table body
      tbody.innerHTML = '';

      filteredData.forEach(d => {
        Object.entries(d.characteristics).forEach(([variable, value]) => {
          // Apply search filter
          const matchesSearch = variable.toLowerCase().includes(searchTerm) || value.toLowerCase().includes(searchTerm);

          // Check if value has n < 10 (privacy protection)
          if (matchesSearch && !hasSmallN(value)) {
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-50';
            row.innerHTML = `
              <td class="px-4 py-3 text-sm text-gray-700 font-medium">${variable}</td>
              <td class="px-4 py-3 text-sm text-gray-700">${value}</td>
            `;
            tbody.appendChild(row);
          }
        });
      });
    } else if (shouldPivotBySites) {
      // Pivot mode: Sites as columns (single year, multiple sites)
      const year = selectedYears[0];

      // Update table headers
      thead.innerHTML = `
        <th class="px-4 py-3 text-left font-semibold">Characteristic</th>
        ${selectedSites.map(site => `<th class="px-4 py-3 text-left font-semibold">${site}</th>`).join('')}
      `;

      // Collect all unique characteristics
      const characteristicsMap = new Map();

      filteredData.forEach(d => {
        Object.entries(d.characteristics).forEach(([variable, value]) => {
          if (!characteristicsMap.has(variable)) {
            characteristicsMap.set(variable, {});
          }
          characteristicsMap.get(variable)[d.site] = value;
        });
      });

      // Populate table body
      tbody.innerHTML = '';

      characteristicsMap.forEach((siteValues, variable) => {
        // Apply search filter
        const matchesSearch = variable.toLowerCase().includes(searchTerm) ||
          Object.values(siteValues).some(v => v.toLowerCase().includes(searchTerm));

        // Check if any value in the row has n < 10 (privacy protection)
        const rowValues = selectedSites.map(site => siteValues[site] || '-');
        const hasPrivacyIssue = rowHasSmallN(rowValues);

        if (matchesSearch && !hasPrivacyIssue) {
          const row = document.createElement('tr');
          row.className = 'hover:bg-gray-50';

          let html = `<td class="px-4 py-3 text-sm text-gray-700 font-medium">${variable}</td>`;
          selectedSites.forEach(site => {
            const value = siteValues[site] || '-';
            html += `<td class="px-4 py-3 text-sm text-gray-700">${value}</td>`;
          });

          row.innerHTML = html;
          tbody.appendChild(row);
        }
      });
    } else if (shouldPivotByYears) {
      // Pivot mode: Years as columns (single site, multiple years)
      const site = selectedSites[0];

      // Collect all unique characteristics and determine which years have data
      const characteristicsMap = new Map();
      const yearsWithData = new Set();

      filteredData.forEach(d => {
        Object.entries(d.characteristics).forEach(([variable, value]) => {
          if (!characteristicsMap.has(variable)) {
            characteristicsMap.set(variable, {});
          }
          characteristicsMap.get(variable)[d.year] = value;
          yearsWithData.add(d.year);
        });
      });

      // Get only years that have actual data, maintaining selected order
      const availableYears = selectedYears.filter(year => yearsWithData.has(year));

      // Update table headers
      thead.innerHTML = `
        <th class="px-4 py-3 text-left font-semibold">Characteristic</th>
        ${availableYears.map(year => `<th class="px-4 py-3 text-left font-semibold">${year}</th>`).join('')}
      `;

      // Populate table body
      tbody.innerHTML = '';

      characteristicsMap.forEach((yearValues, variable) => {
        // Apply search filter
        const matchesSearch = variable.toLowerCase().includes(searchTerm) ||
          Object.values(yearValues).some(v => v.toLowerCase().includes(searchTerm));

        // Check if any value in the row has n < 10 (privacy protection)
        const rowValues = availableYears.map(year => yearValues[year] || '-');
        const hasPrivacyIssue = rowHasSmallN(rowValues);

        if (matchesSearch && !hasPrivacyIssue) {
          const row = document.createElement('tr');
          row.className = 'hover:bg-gray-50';

          let html = `<td class="px-4 py-3 text-sm text-gray-700 font-medium">${variable}</td>`;
          availableYears.forEach(year => {
            const value = yearValues[year] || '-';
            html += `<td class="px-4 py-3 text-sm text-gray-700">${value}</td>`;
          });

          row.innerHTML = html;
          tbody.appendChild(row);
        }
      });
    } else if (selectedSites.length > 1 && selectedYears.length > 1) {
      // Multiple sites AND multiple years: Show site-year columns + Consortium aggregation

      // Create site-year combinations for headers
      const siteYearCombos = [];
      filteredData.forEach(d => {
        const combo = `${d.site}-${d.year}`;
        if (!siteYearCombos.includes(combo)) {
          siteYearCombos.push(combo);
        }
      });

      // Update table headers
      thead.innerHTML = `
        <th class="px-4 py-3 text-left font-semibold">Characteristic</th>
        ${siteYearCombos.map(combo => `<th class="px-4 py-3 text-left font-semibold">${combo}</th>`).join('')}
        <th class="px-4 py-3 text-left font-semibold bg-clif-burgundy bg-opacity-10">Consortium</th>
      `;

      // Collect all characteristics and their values per site-year
      const characteristicsMap = new Map();

      filteredData.forEach(d => {
        const combo = `${d.site}-${d.year}`;
        Object.entries(d.characteristics).forEach(([variable, value]) => {
          if (!characteristicsMap.has(variable)) {
            characteristicsMap.set(variable, {});
          }
          characteristicsMap.get(variable)[combo] = value;
        });
      });

      // Get denominators for each site-year combo
      const siteYearDenominators = new Map();
      filteredData.forEach(d => {
        const combo = `${d.site}-${d.year}`;
        const nEncounters = getNumeric(d.characteristics['N: Encounter blocks']) || 0;
        const nPatients = getNumeric(d.characteristics['N: Unique patients']) || 0;
        siteYearDenominators.set(combo, {
          nEncounterBlocks: nEncounters,
          nUniquePatients: nPatients
        });
      });

      // Populate table body
      tbody.innerHTML = '';

      characteristicsMap.forEach((comboValues, variable) => {
        // Apply search filter
        const matchesSearch = variable.toLowerCase().includes(searchTerm) ||
          Object.values(comboValues).some(v => v.toLowerCase().includes(searchTerm));

        // Check if any value in the row has n < 10 (privacy protection)
        const rowValues = siteYearCombos.map(combo => comboValues[combo] || '-');
        const hasPrivacyIssue = rowHasSmallN(rowValues);

        if (matchesSearch && !hasPrivacyIssue) {
          const row = document.createElement('tr');
          row.className = 'hover:bg-gray-50';

          let html = `<td class="px-4 py-3 text-sm text-gray-700 font-medium">${variable}</td>`;

          // Add each site-year value
          siteYearCombos.forEach(combo => {
            const value = comboValues[combo] || '-';
            html += `<td class="px-4 py-3 text-sm text-gray-700">${value}</td>`;
          });

          // Calculate consortium aggregated value
          const siteYearData = siteYearCombos.map(combo => ({
            value: comboValues[combo] || '-',
            nEncounterBlocks: siteYearDenominators.get(combo)?.nEncounterBlocks || 0,
            nUniquePatients: siteYearDenominators.get(combo)?.nUniquePatients || 0
          }));

          const consortiumValue = aggregateConsortiumValue(variable, siteYearData);
          html += `<td class="px-4 py-3 text-sm text-gray-700 font-semibold bg-clif-burgundy bg-opacity-5">${consortiumValue}</td>`;

          row.innerHTML = html;
          tbody.appendChild(row);
        }
      });
    } else {
      // Standard mode: Original layout
      thead.innerHTML = `
        <th class="px-4 py-3 text-left font-semibold">Characteristic</th>
        <th class="px-4 py-3 text-left font-semibold">Site</th>
        <th class="px-4 py-3 text-left font-semibold">Year</th>
        <th class="px-4 py-3 text-left font-semibold">Value</th>
      `;

      tbody.innerHTML = '';

      filteredData.forEach(d => {
        Object.entries(d.characteristics).forEach(([variable, value]) => {
          const matchesSearch = variable.toLowerCase().includes(searchTerm) || value.toLowerCase().includes(searchTerm);

          // Check if value has n < 10 (privacy protection)
          if (matchesSearch && !hasSmallN(value)) {
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-50';
            row.innerHTML = `
              <td class="px-4 py-3 text-sm text-gray-700">${variable}</td>
              <td class="px-4 py-3 text-sm text-gray-700">${d.site}</td>
              <td class="px-4 py-3 text-sm text-gray-700">${d.year}</td>
              <td class="px-4 py-3 text-sm text-gray-700">${value}</td>
            `;
            tbody.appendChild(row);
          }
        });
      });
    }
  }

  function exportToCSV() {
    const filteredData = getFilteredData();

    let csv = 'Characteristic,Site,Year,Value\n';

    filteredData.forEach(d => {
      Object.entries(d.characteristics).forEach(([variable, value]) => {
        // Only export if value doesn't have n < 10 (privacy protection)
        if (!hasSmallN(value)) {
          csv += `"${variable}","${d.site}","${d.year}","${value}"\n`;
        }
      });
    });

    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `clif-consortium-data-${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
  }
</script>

<style>
  .interactive-dashboard {
    animation: fadeIn 0.5s ease-in;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  #data-table {
    font-size: 0.875rem;
  }

  #data-table thead {
    position: sticky;
    top: 0;
    z-index: 1;
  }

  /* Category Sidebar Styles */
  .category-header:hover {
    background-color: rgb(249, 250, 251);
  }

  .characteristic-list {
    display: none;
    background-color: rgb(249, 250, 251);
  }

  .characteristic-item {
    border-left: 3px solid transparent;
  }

  .characteristic-item:hover {
    border-left-color: rgb(136, 19, 55);
  }

  .characteristic-item.bg-clif-burgundy {
    border-left-color: rgb(136, 19, 55);
  }

  .chevron {
    transition: transform 0.2s ease;
  }

  /* Scrollbar styling for sidebar */
  #categories-list::-webkit-scrollbar {
    width: 8px;
  }

  #categories-list::-webkit-scrollbar-track {
    background: rgb(243, 244, 246);
  }

  #categories-list::-webkit-scrollbar-thumb {
    background: rgb(209, 213, 219);
    border-radius: 4px;
  }

  #categories-list::-webkit-scrollbar-thumb:hover {
    background: rgb(156, 163, 175);
  }
</style>
